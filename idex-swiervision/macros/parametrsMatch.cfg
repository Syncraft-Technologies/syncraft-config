[gcode_macro PARAMETERS_MATCH]
gcode = 
	{% set dcvars = printer["gcode_macro DC_VARS"] %}
	{% set svv = printer.save_variables.variables %}
	{% set mat0 = params.MAT0|default('none')|string %}
	{% set mat1 = params.MAT1|default('none')|string %}
	{% set nozzle0 = params.NZ0|default('none')|string %}
	{% set nozzle1 = params.NZ1|default('none')|string %}
	{% set MACHINE = params.MACHINE|default('none')|string %}
	{% set enabled = params.ENABLED|default('none')|string %}
	{% set initial_extruder = params.INITIAL_EXT|default('0')|string %}
	{% set filament_usage = params.F[1:][:-1].replace(' ', '').split(',') %}
	
	{% set INCOMPATIBLE_MATERIAL = "The material you're using is not compatible with this file" %}
	{% set INCOMPATIBLE_EXTRUDER = "The inserted Extruder is incompatible with this File" %}
	{% set INCOMPATIBLE_MODEL = "The file you are trying to print is for a different printer model" %}
	{% set NO_MATERIAL_FEEDER_1 = "The Filament is not inserted into the first feeder" %}
	{% set NO_MATERIAL_FEEDER_2 = "The Filament is not inserted into the second feeder" %}
	
	{% if filament_usage[1] is defined %}
	{% set material_usage = [filament_usage[0]|float, filament_usage[1]|float] %}
	{% else %}
	{% set material_usage = [filament_usage[0]|float, 0.0] %}
	{% endif %}
	
	{% if material_usage[1] != 0.0 %}
	SET_GCODE_VARIABLE MACRO=DC_VARS VARIABLE=extruder1_in_use VALUE=1
	M104 T1 S150
	{% endif %}
	
	{% if dcvars.setup_verification == 1 %}
	{% set both_in_use = true %}
	
	{% if material_usage[0] == 0.0 and material_usage[1] != 0.0 %}
	{% set both_in_use = false %}
	{% set material = svv.material_ext1 %}
	{% set received_material = mat1 %}
	{% set saved_nozzle = svv.nozzle1 %}
	{% set received_nozzle = nozzle1 %}
	{% elif material_usage[0] != 0.0 and material_usage[1] == 0.0 %}
	{% set both_in_use = false %}
	{% set material = svv.material_ext0 %}
	{% set received_material = mat0 %}
	{% set saved_nozzle = svv.nozzle0 %}
	{% set received_nozzle = nozzle0 %}
	{% endif %}
	
	{% if not both_in_use %} # If only one of the extruders is used
	SET_GCODE_VARIABLE MACRO=DC_VARS VARIABLE=extruders_enabled VALUE=1
	{% if material in 'GENERIC' %}
	{% set is_generic = true %}
	{% endif %}
	{% if material not in received_material %}
	{% if not is_generic %}
	CANCEL_PRINT_WITH_ERROR MSG="{INCOMPATIBLE_MATERIAL}"
	{% endif %}
	{% endif %}
	{% if saved_nozzle != received_nozzle %}
	CANCEL_PRINT_WITH_ERROR MSG="{INCOMPATIBLE_EXTRUDER}"
	{% endif %}
	{% else %} # In this case, both extruders will be used
	SET_GCODE_VARIABLE MACRO=DC_VARS VARIABLE=extruders_enabled VALUE=2
	{% if svv.material_ext0 not in mat0 %}
	{% if svv.material_ext0 not in 'GENERIC' %}
	CANCEL_PRINT_WITH_ERROR MSG="{INCOMPATIBLE_MATERIAL}"
	{% endif %}
	{% endif %}
	{% if svv.material_ext1 not in mat1 %}
	{% if svv.material_ext1 not in 'GENERIC' %}
	CANCEL_PRINT_WITH_ERROR MSG="{INCOMPATIBLE_MATERIAL}"
	{% endif %}
	{% endif %}
	{% if svv.nozzle0 not in nozzle0 %}
	CANCEL_PRINT_WITH_ERROR MSG="{INCOMPATIBLE_EXTRUDER}"
	{% endif %}
	{% if svv.nozzle1 not in nozzle1 %}
	CANCEL_PRINT_WITH_ERROR MSG="{INCOMPATIBLE_EXTRUDER}"
	{% endif %}
	{% endif %}
	{% endif %}
	
	{% if svv.machine != MACHINE %}
	CANCEL_PRINT_WITH_ERROR MSG="{INCOMPATIBLE_MODEL}"
	{% endif %}
	
	{% if dcvars.sensor_verification == 1 %}
	{% if dcvars.active_carriage == 0 %}
	{% if printer['filament_switch_sensor spool_one'].filament_detected != true %}
	CANCEL_PRINT_WITH_ERROR MSG="{NO_MATERIAL_FEEDER_1}"
	{% endif %}
	{% else %}
	{% if printer['filament_switch_sensor spool_two'].filament_detected != true %}
	CANCEL_PRINT_WITH_ERROR MSG="{NO_MATERIAL_FEEDER_2}"
	{% endif %}
	{% endif %}
	{% endif %}
	
	SET_GCODE_VARIABLE MACRO=DC_VARS VARIABLE=material_cura0 VALUE="'{mat0}'"
	SET_GCODE_VARIABLE MACRO=DC_VARS VARIABLE=material_cura1 VALUE="'{mat1}'"